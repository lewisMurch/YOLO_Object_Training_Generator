import random
from PIL import Image

def overlay_image_with_bb_cropped(bg_img_path, overlay_img_path, save_img_path, num_repeats):
    # Open the background image
    bg_img = Image.open(bg_img_path)

    # Open the overlay image
    overlay_img = Image.open(overlay_img_path)

    # Get the width and height of the background image
    bg_width, bg_height = bg_img.size

    # Get the width and height of the overlay image
    overlay_width, overlay_height = overlay_img.size

    for i in range(num_repeats):
        # Generate random coordinates for the overlay image
        x = random.randint(0, bg_width - overlay_width)
        y = random.randint(0, bg_height - overlay_height)

        # Randomly decide whether to crop on the X or Y axis
        axis = random.choice(['X', 'Y'])

        if axis == 'X':
            # Generate a random crop on the X axis
            x_start = random.randint(0, overlay_width)
            x_end = x_start + overlay_width
            overlay_img_cropped = overlay_img.crop((x_start, 0, x_end, overlay_height))

            # Update the bounding box information
            x += x_start
            overlay_width = overlay_img_cropped.width
        else:
            # Generate a random crop on the Y axis
            y_start = random.randint(0, overlay_height)
            y_end = y_start + overlay_height
            overlay_img_cropped = overlay_img.crop((0, y_start, overlay_width, y_end))

            # Update the bounding box information
            y += y_start
            overlay_height = overlay_img_cropped.height

        # Paste the overlay image onto the background image
        bg_img.paste(overlay_img_cropped, (x, y), overlay_img_cropped)

        # Save the result
        bg_img_name = save_img_path + str(i) + ".jpg"
        bg_img.save(bg_img_name)
        
        # Save the bounding box information in YOLO format
        bb_txt_name = save_img_path + str(i) + ".txt"
        with open(bb_txt_name, "w") as f:
            f.write("0 " + str(x/bg_width) + " " + str(y/bg_height) + " " + str(overlay_width/bg_width) + " " + str(overlay_height/bg_height))
